<? namespace Bitrix\Main\Security\W;$GLOBALS['____234468761']= array(base64_decode('dG'.'ltZQ='.'='),base64_decode('dGltZQ=='),base64_decode('anN'.'v'.'bl9k'.'Z'.'WNvZ'.'GU='),base64_decode('YXJyYXlfbWV'.'yZ2U='),base64_decode('am9p'.'b'.'g='.'='),base64_decode('am9pbg=='),base64_decode(''.'a'.'m9'.'pbg'.'=='),base64_decode('YX'.'JyYXlfcG9w'),base64_decode('Y'.'XJ'.'yYXlf'.'c2'.'hpZnQ'.'='),base64_decode('YXJ'.'yYXlfc2hpZnQ='),base64_decode('YXJ'.'y'.'YXl'.'fc'.'2hpZn'.'Q='),base64_decode('YX'.'J'.'yYX'.'lfc2hpZn'.'Q='),base64_decode('YXJyYXlfbWVy'.'Z2'.'U='),base64_decode('a'.'XNfYX'.'JyY'.'Xk='),base64_decode('Y'.'X'.'JyYXlfbWVyZ2U='),base64_decode(''.'aW5fYXJyYXk='),base64_decode('aW5'.'fYX'.'JyYXk'.'='),base64_decode(''.'aW5f'.'Y'.'XJ'.'yY'.'Xk='),base64_decode('aW5fYX'.'Jy'.'YXk='),base64_decode('aW'.'5fYXJyYX'.'k='),base64_decode('dG'.'ltZQ'.'=='),base64_decode('d'.'GltZQ=='),base64_decode('Y'.'X'.'J'.'yYXlfbW'.'F'.'w'),base64_decode('Z2V0X2xvYW'.'RlZF9l'.'eHRlb'.'nNpb'.'25'.'z'),base64_decode('anNvb'.'l'.'9lbmNv'.'ZGU='),base64_decode(''.'anNvbl9lbmNvZGU'.'='),base64_decode('cGhw'.'dmV'.'yc2'.'lvbg=='),base64_decode('a'.'n'.'N'.'v'.'bl9l'.'b'.'mN'.'vZGU='),base64_decode('a'.'m'.'9'.'pbg=='));if(!function_exists(__NAMESPACE__.'\\___798195219')){function ___798195219($_1464304919){static $_1778443297= false; if($_1778443297 == false) $_1778443297=array('V1dBTE'.'xfTE'.'9DSw==','c'.'2'.'VjdXJpdH'.'k=','REFUQQ==',''.'eyI=','V1dBT'.'ExfTE9D'.'Sw==','c2Vjd'.'XJ'.'pd'.'Hk=','U'.'0V'.'D'.'V'.'VJJVFlfV'.'1'.'dBTExfRV'.'hDR'.'VBUSU'.'9'.'O',''.'R'.'kFJTF9DS'.'E'.'VDS0lORw==','Q2'.'FuI'.'G5v'.'dCBl'.'eGVjd'.'XRlI'.'H'.'d3Y'.'WxsIHJ1bGVz'.'OiA=',''.'IFRyYWNlOi'.'A=','U'.'kVRVUVTVF9VUkk=','a2V5c'.'w==','dm'.'F'.'sd'.'WVz','U'.'0VDV'.'VJJVF'.'l'.'fV'.'1'.'dBTExf'.'TU'.'9ESUZZ','Lg==','U'.'0VD'.'VV'.'JJ'.'VFlf'.'V'.'1d'.'BTExfVU5'.'TR'.'VQ=','Lg'.'='.'=','U0VDVVJJVFlfV'.'1dBTExf'.'RVhJVA==','Lg==','Z2xv'.'YmFs','a2'.'V5'.'cw==','dmFsd'.'WVz','Z'.'2V'.'0','Z2'.'V0','c'.'G9zdA==','cG9'.'zdA==','Y'.'29v'.'a2ll','Y'.'29va'.'2ll','c'.'mVxdWVzd'.'A==','c'.'mV'.'xdWVzdA'.'='.'=','Z2xvYm'.'Fs','Z2'.'xvYmFs','bWFpbl9zZWM'.'=',''.'V1dBT'.'Ex'.'fQUNU'.'VU'.'FMSVpFX1'.'JVTEVT','dg='.'=','dm'.'Vyc2lvb'.'g==',''.'a'.'Q==','aX'.'NJbnN0YWxs'.'ZWQ=','dg==',''.'aW5p','bW'.'9kdWxlcw'.'==','bGlj'.'ZW5zZQ==','cGh'.'w','dg==','ZXh'.'0','c'.'2V'.'jdXJ'.'pdHk=','ZGI=','dHlwZ'.'Q==','ZGI=',''.'dmVyc'.'2lvbg==',''.'ZGI=','dHlwZQ==','ZGI=','dHl'.'wZ'.'Q='.'=','d'.'mVyc2lvbg==','ZG'.'I=',''.'dmVyc2lvbg'.'==','ZW'.'52aXJv'.'bm1lbnQ=','dm1fdm'.'Vyc2lvbg='.'=','dm0'.'=','d'.'g==','Z'.'W52a'.'XJvbm'.'1lbnQ=','dm1fdmVyc2lv'.'bg==',''.'c2'.'9ja2V0V'.'GltZW9'.'1dA==','c'.'3Ry'.'ZWFtVG'.'l'.'tZW91d'.'A='.'=','KCc'.'=','ZGF0Y'.'Q'.'==',''.'JywgJ'.'w==',''.'bW9kdWxl',''.'Jywg'.'Jw==','b'.'W9'.'k'.'d'.'WxlX'.'3Zlc'.'nNpb24=','Jyk=','LCA=',''.'U'.'0VDVVJJVFlfV1d'.'BTE'.'xfRVhDRVBUSU9'.'O','bWF'.'pbg==','RkFJTF9'.'SRUZSRVNISU5H','Q2'.'FuIG'.'5v'.'dCByZWZyZXNoI'.'H'.'d'.'3YWx'.'sIHJ1'.'b'.'GV'.'z'.'OiA=',''.'IFRy'.'YWNlOiA=','ZGF0'.'YQ==','eyI=',''.'LS0tLS1CR'.'UdJTiBQVUJM'.'SUMgS0V'.'ZLS0tLS0=','C'.'k1JSUJJak'.'FOQmdrcWhra'.'Uc5'.'dz'.'B'.'CQV'.'FFRkF'.'BT'.'0NBUT'.'hB'.'TUl'.'JQkNnS0NBUUV'.'Bc'.'ThRRT'.'BIam1'.'ISlV'.'TdFd'.'WNm4we'.'mEKUlZvTHgwMk'.'t'.'6YmZ'.'yYlMvUD'.'ZzV2'.'F4VH'.'p'.'3O'.'FNlR1R0YlRD'.'T'.'3JwSGk1UUY2T1'.'J'.'5alovW'.'Hh'.'6L0tMVTFHYm'.'9'.'m'.'OUNaM'.'wo0e'.'jd'.'T'.'a3'.'FV'.'dDY2aW'.'JY'.'dk'.'9G'.'Qng'.'0Znc'.'vQVB'.'QUkdE'.'cXRtM'.'G5'.'EM2'.'Z'.'nR'.'3N1M1JlU'.'Gd'.'3Mjl'.'p'.'O'.'Ct2bT'.'d'.'tdEJLSlVZb'.'DRyC'.'lZwY'.'jZzZlpFVDlLRWI2VDF'.'I'.'RFltRXZjMWhx'.'L2lpdX'.'l4THJaW'.'mk1UTZVZm'.'Y0VUV2VEkr'.'Njh'.'zc0ZSa1E'.'rb3'.'dUUnkKZ'.'U9'.'J'.'TW'.'JGaE'.'0vVVRtZlZZY'.'lR'.'SRnky'.'b1VROFdNe'.'mEybko1U2Foe'.'mkx'.'V'.'UtPMW'.'p'.'BalhUUFJyemM3QWp1N'.'jM5ajFP'.'MApw'.'cHFmbTV4Z1'.'dsRkFKa0'.'hRV'.'Gdi'.'Z'.'GQ1QV'.'d'.'x'.'REZ'.'Ra'.'3Q5'.'SEtrWStUbmZCT'.'EdW'.'T'.'XZ'.'WeVB'.'3V'.'EhOV'.'1FZQXc0eHBnL3dBClp3'.'SURBUUFCCi0tLS0tRU5EI'.'FBVQkxJQyBL'.'R'.'VktL'.'S0'.'tLQ==');return base64_decode($_1778443297[$_1464304919]);}}; use Bitrix\Main\Application; use Bitrix\Main\Config\Option; use Bitrix\Main\Data\Cache; use Bitrix\Main\Loader; use Bitrix\Main\ModuleManager; use Bitrix\Main\Security\PublicKeyCipher; use Bitrix\Main\SystemException; use Bitrix\Main\Web\HttpClient; use Bitrix\Main\Web\Json; use Bitrix\Main\Security\W\Rules\Rule; use Bitrix\Main\Security\W\Rules\Results\RuleAction; use Bitrix\Main\Security\W\Rules\Results\RuleResult; use Bitrix\Main\Security\W\Rules\Results\CheckResult; use Bitrix\Main\Security\W\Rules\Results\ModifyResult; use Bitrix\Main\Type\ArrayHelper; use Bitrix\Main\Security\W\Rules\RuleRecordTable; use CSecuritySystemInformation; use ReflectionExtension; class WWall{ const CACHE_RULES_TTL= 10800; private static $_1470894791= 'https://wwall.bitrix.info/rules.php'; protected $_1299269294= true; public function handle(){ try{  $_998596514= RuleRecordTable::getList([ 'cache' =>['ttl' => 3600* 24* 7]])->fetchAll(); if(empty($_998596514)){ return;}  $_221838196= Cache::createInstance(); $_1910327430= false; if($_221838196->initCache(static::CACHE_RULES_TTL, 'WWALL_LOCK', 'security')){ $_273510095= $_221838196->getVars(); if($GLOBALS['____234468761'][0]()- $_273510095> round(0+6.6666666666667+6.6666666666667+6.6666666666667)){  $_87515006= Application::getConnection(); $_523206559= RuleRecordTable::getTableName(); $_87515006->truncateTable($_523206559); RuleRecordTable::cleanCache(); $_221838196->clean(___798195219(0), ___798195219(1));}} elseif($_221838196->startDataCache()){  $_221838196->endDataCache($GLOBALS['____234468761'][1]()); $_1910327430= true;} foreach($_998596514 as $_258380473){ $_717726331= new PublicKeyCipher; $_2002017837= $_717726331->decrypt($_258380473[___798195219(2)], static::__988095433()); if(!str_starts_with($_2002017837, ___798195219(3))){ continue;} $_376938354= $GLOBALS['____234468761'][2]($_2002017837, true); if(!empty($_376938354)){ $_1026658956= Rule::make($_376938354); $_1552987717= $this->handleRule($_1026658956); $this->applyHandlingResults($_1552987717);}}  if($_1910327430){ $_221838196->clean(___798195219(4), ___798195219(5));}} catch(\Throwable $_653550542){ $this->logEvent( ___798195219(6), ___798195219(7), ___798195219(8). $_653550542->getMessage(). ___798195219(9). $_653550542->getTraceAsString());}}  public function handleRule(Rule $_1026658956): array{ $_1552987717=[]; if($_1026658956->matchPath($_SERVER[___798195219(10)])){  $_1814542396= $this->getContextElements($_1026658956->getContext()); foreach($_1814542396 as $_667604915 => &$_1371354212){ $_1552987717= $GLOBALS['____234468761'][3]($_1552987717, $this->recursiveContextKeyHandle($_667604915, $_1371354212,[], $_1026658956));}} return $_1552987717;}  public function applyHandlingResults(array $_1552987717){ $_1814542396= $this->getContextElements([ 'get', 'post', 'cookie', 'request', 'global']); foreach($_1552987717 as $_530932684){ $_1371354212=& $_1814542396[$_530932684->getContextName()]; $_1229293500= $_530932684->getRuleResult(); $_1026658956= $_530932684->getRule(); if($_1229293500 instanceof ModifyResult){ if($_1026658956->getProcess() === ___798195219(11)){  static::rewriteContextKey( $_530932684->getContextName(), $_1371354212, $_530932684->getContextKey(), $_1229293500->getCleanValue());} elseif($_1026658956->getProcess() === ___798195219(12)){ static::rewriteContextValue( $_530932684->getContextName(), $_1371354212, $_530932684->getContextKey(), $_1229293500->getCleanValue());} $this->logEvent( ___798195219(13), $_530932684->getContextName(), $GLOBALS['____234468761'][4](___798195219(14), $_530932684->getContextKey()));} elseif($_1229293500 instanceof CheckResult &&!$_1229293500->isSuccess()){ if($_1229293500->getAction() === RuleAction::UNSET){ static::unsetContextValue( $_530932684->getContextName(), $_1371354212, $_530932684->getContextKey(),); $this->logEvent( ___798195219(15), $_530932684->getContextName(), $GLOBALS['____234468761'][5](___798195219(16), $_530932684->getContextKey()));} elseif($_1229293500->getAction() === RuleAction::EXIT){ $this->logEvent( ___798195219(17), $_530932684->getContextName(), $GLOBALS['____234468761'][6](___798195219(18), $_530932684->getContextKey())); exit;}}}} public function disableEventLogging(){ $this->_1299269294= false;} protected function rewriteContextKey($_667604915, &$_1371354212, $_803097523, $_1985464585){ $_940306469= $_803097523;  $GLOBALS['____234468761'][7]($_940306469); $_940306469[]= $_1985464585; if($_667604915 === ___798195219(19)){ $_1587689516= $GLOBALS['____234468761'][8]($_803097523); $GLOBALS['____234468761'][9]($_940306469); if(empty($_803097523)){ $GLOBALS[$_1985464585]= $GLOBALS[$_1587689516]; unset($GLOBALS[$_1587689516]);} else{ $_1371354212=& $GLOBALS[$_1587689516]; $_1938975917= ArrayHelper::getByNestedKey($_1371354212, $_803097523);  ArrayHelper::setByNestedKey($_1371354212, $_940306469, $_1938975917);  ArrayHelper::unsetByNestedKey($_1371354212, $_803097523);}} else{ $_1938975917= ArrayHelper::getByNestedKey($_1371354212, $_803097523);  ArrayHelper::setByNestedKey($_1371354212, $_940306469, $_1938975917);  ArrayHelper::unsetByNestedKey($_1371354212, $_803097523);}} protected function rewriteContextValue($_667604915, &$_1371354212, $_577857716, $_1938975917){ if($_667604915 === 'global'){ $_1587689516= $GLOBALS['____234468761'][10]($_577857716); if(empty($_577857716)){ $GLOBALS[$_1587689516]= $_1938975917;} else{ $_1371354212=& $GLOBALS[$_1587689516]; ArrayHelper::setByNestedKey($_1371354212, $_577857716, $_1938975917);}} else{  ArrayHelper::setByNestedKey($_1371354212, $_577857716, $_1938975917);}} protected function unsetContextValue($_667604915, &$_1371354212, $_577857716){ if($_667604915 === 'global'){ $_1587689516= $GLOBALS['____234468761'][11]($_577857716); if(empty($_577857716)){ unset($GLOBALS[$_1587689516]);} else{ $_1371354212=& $GLOBALS[$_1587689516]; ArrayHelper::unsetByNestedKey($_1371354212, $_577857716);}} else{ ArrayHelper::unsetByNestedKey($_1371354212, $_577857716);}}  protected function recursiveContextKeyHandle(string $_667604915, array &$_1371354212, array $_692231056, Rule $_1026658956): array{  $_1552987717=[]; foreach($_1371354212 as $_278138957 => $_1938975917){ $_577857716= $GLOBALS['____234468761'][12]($_692231056,[$_278138957]); if($_1026658956->matchKey($_577857716)){  if($_1026658956->getProcess() === ___798195219(20)){ $_1229293500= $_1026658956->evaluate($_278138957);} elseif($_1026658956->getProcess() === ___798195219(21)){ $_1229293500= $_1026658956->evaluateValue($_1938975917);}  if(!empty($_1229293500) && $_1229293500 instanceof RuleResult){ $_1552987717[]= new HandlingResult($_667604915, $_577857716, $_1229293500, $_1026658956);}}  if($GLOBALS['____234468761'][13]($_1938975917)){ $_1552987717= $GLOBALS['____234468761'][14]($_1552987717, $this->recursiveContextKeyHandle( $_667604915, $_1371354212[$_278138957], $_577857716, $_1026658956));}} return $_1552987717;} protected function getContextElements(array $_2141675235){ $_992522165=[]; if($GLOBALS['____234468761'][15](___798195219(22), $_2141675235, true)){ $_992522165[___798195219(23)]= &$_GET;} if($GLOBALS['____234468761'][16](___798195219(24), $_2141675235, true)){ $_992522165[___798195219(25)]= &$_POST;} if($GLOBALS['____234468761'][17](___798195219(26), $_2141675235, true)){ $_992522165[___798195219(27)]= &$_COOKIE;} if($GLOBALS['____234468761'][18](___798195219(28), $_2141675235, true)){ $_992522165[___798195219(29)]= &$_REQUEST;} if($GLOBALS['____234468761'][19](___798195219(30), $_2141675235, true)){ $_992522165[___798195219(31)]= $GLOBALS;} return $_992522165;} public static function refreshRules(){ try{ $_358413489= Option::get('main_sec', 'WWALL_ACTUALIZE_RULES', 0); if(($GLOBALS['____234468761'][20]()- $_358413489)< static::CACHE_RULES_TTL){ return;} Option::set(___798195219(32), ___798195219(33), $GLOBALS['____234468761'][21]()); $_1990129170= null;  $_1696313138= $GLOBALS['____234468761'][22](function($_1861854464){ return[___798195219(34) => $_1861854464[___798195219(35)], ___798195219(36) => (int) $_1861854464[___798195219(37)]];}, ModuleManager::getModulesFromDisk());  $_1871233126=[]; foreach($GLOBALS['____234468761'][23]() as $_1617219029){ $_1163788438= new ReflectionExtension($_1617219029); $_1871233126[$_1617219029]=[ ___798195219(38) => $_1163788438->getVersion(), ___798195219(39) => $_1163788438->getINIEntries()];} $_1924243052=[ ___798195219(40) => $GLOBALS['____234468761'][24]($_1696313138), ___798195219(41) => Application::getInstance()->getLicense()->getHashLicenseKey(), ___798195219(42) => $GLOBALS['____234468761'][25]([ ___798195219(43) => $GLOBALS['____234468761'][26](), ___798195219(44) => $_1871233126])]; if(Loader::includeModule(___798195219(45))){ $_65085017= CSecuritySystemInformation::getSystemInformation(); if(isset($_65085017[___798195219(46)][___798195219(47)]) && isset($_65085017[___798195219(48)][___798195219(49)])){ $_1924243052[___798195219(50)]=[ ___798195219(51) => $_65085017[___798195219(52)][___798195219(53)], ___798195219(54) => $_65085017[___798195219(55)][___798195219(56)]];} if(isset($_65085017[___798195219(57)][___798195219(58)])){ $_1924243052[___798195219(59)]=[___798195219(60) => $_65085017[___798195219(61)][___798195219(62)]];}}  $_1458897716= new HttpClient([ ___798195219(63) => round(0+2.5+2.5), ___798195219(64) => round(0+1.6666666666667+1.6666666666667+1.6666666666667)]); $_951512932= $_1458897716->post( static::$_1470894791, $_1924243052); if($_1458897716->getStatus() == round(0+66.666666666667+66.666666666667+66.666666666667) &&!empty($_951512932)){ $_1990129170= Json::decode($_951512932);}  if($_1990129170 !== null){ $_87515006= Application::getConnection(); $_523206559= RuleRecordTable::getTableName(); if(!empty($_1990129170)){ foreach($_1990129170 as $_295488663){ if(!static::checkRuleSign($_295488663)){ throw new SystemException('Invalid sign for rule '.$GLOBALS['____234468761'][27]($_295488663));}}}  $_87515006->truncateTable($_523206559);  if(!empty($_1990129170)){ $_707573995=[]; foreach($_1990129170 as $_295488663){ $_707573995[]= ___798195219(65). $_87515006->getSqlHelper()->forSql($_295488663[___798195219(66)]). ___798195219(67). $_87515006->getSqlHelper()->forSql($_295488663[___798195219(68)]). ___798195219(69). $_87515006->getSqlHelper()->forSql($_295488663[___798195219(70)]). ___798195219(71);} $_2091752808= $GLOBALS['____234468761'][28](___798195219(72), $_707573995);  $_87515006->query("INSERT INTO {$_523206559} (DATA, MODULE, MODULE_VERSION) VALUES {$_2091752808}");  RuleRecordTable::cleanCache();}}} catch(\Throwable $_653550542){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, ___798195219(73), ___798195219(74), ___798195219(75), ___798195219(76). $_653550542->getMessage(). ___798195219(77). $_653550542->getTraceAsString());}} protected static function checkRuleSign($_1026658956){ $_717726331= new PublicKeyCipher; $_376938354= $_717726331->decrypt($_1026658956[___798195219(78)], static::__988095433()); return str_starts_with($_376938354, ___798195219(79));} private static function __988095433(){ $_1455686817= ''; $_1455686817 .= ___798195219(80); $_1455686817 .= ___798195219(81); return $_1455686817;} protected function logEvent($_651832769, $_772452506, $_1870672506){ if($this->_1299269294){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, $_651832769, 'main', $_772452506, $_1870672506);}}}?>